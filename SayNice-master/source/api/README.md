SayNice 匿名情感倾诉社区

## Say Nice API Server

SayNice.xyz 后端 API 源码.

使用 gin + json + gorm + sqlite3 + freecache + SyncSlice 架构实现。

> 关于主题内容审查，使用随机匿名空间让每个人都有机会参与内容 Review, 了解详情可点击[此处](https://github.com/ThreeTenth/SayNice/wiki/随机匿名空间)

SayNice API 共有 6 个接口开放，另有 3 个接口尚未完成，请等待后续更新.

### API 请求约定

#### API 请求格式

METHOD | URL | REQUEST BODY | RESPONSE BODY 
--- | ------ | ------------ | -------------
仅支持 `GET` 和 `POST` | 请求地址, 可能存在完成相同的请求链接, 但请区分 `method` | `JSON` 数据结构 | `JSON` 数据结构

#### RESPONSE BODY 数据结构

```json
{
    "code": 0,
    "erro": "",
    "data": "$data"
}
```

参数介绍:

参数名 | 含义
------ | -----
code | 返回码, 0 表示成功, 其他数值表示失败
erro | 错误消息, 含代码运行错误日志或数据库异常信息, 不可用于显示
data | 返回对象, code 不为 0, 该参数的值为空

以下 API 将依照以上表格顺序介绍, 其中 RESPONSE BODY 又分为 DATA 和 CODE 两个部分介绍, CODE 仅介绍错误码.

### API

已完成的 6 个接口，接口前缀 `/v1`：

#### /posts

获取主题列表.

##### METHOD: `GET`

##### URL: `/v1/posts?offset=0&limit=10&order=0`

参数含义如下：

参数名 | 含义 | 类型 | 缺省值
----- | ---- | ---- | ------
offset | 从第 `offset` 项读取 | int | `0`
limit | 读取数量 | int | `10`
order | 按主题时间顺序或倒序读取, `0` 表示倒序, `1` 表示顺序 | int | `0`

##### REQUEST BODY: 无

##### DATA 数据结构:

```json
[
  {
    "id": 10002,
    "text": "vscode 升级后智能提示快多了，之前提示的还没手写的快，约等于没有，赞。",
    "status": 1,
    "remark": "",
    "createdAt": "2020-06-10 11:03:00"
  },
  {
    "id": 10000,
    "text": "今天是一个特殊的日子，今天是 SayNice 后端 API 接口运行的第一天，值得好好书写一番。",
    "status": 1,
    "remark": "",
    "createdAt": "2020-06-09 23:33:06"
  }
]
```

> 该接口暂不支持返回列表总页数, 可通过 `CODE == 10020` 判断是否没有更多了

##### CODE 列表

错误码 | 含义
----- | ---- 
10010 | 数据库查询失败, 请查看 `erro` 了解详细日志
10020 | 没有更多了

#### /post/id

获取指定 `ID` 的主题.

##### METHOD: `GET`

##### URL: `/v1/post/10000`

参数含义如下：

参数名 | 含义 | 类型 | 缺省值
----- | ---- | ---- | ------
id | 指定主题的 ID | int | 无, 不填返回 `404`

##### REQUEST BODY: 无

##### DATA 数据结构

```json
{
  "id": 10000,
  "text": "今天是一个特殊的日子，今天是 SayNice 后端 API 接口运行的第一天，值得好好书写一番。",
  "status": 1,
  "remark": "",
  "createdAt": "2020-06-09 23:33:06"
}
```

##### CODE 列表

错误码 | 含义
----- | ---- 
30010 | `id` 参数错误
30020 | 数据库查询失败, 请查看 `erro` 了解详细日志
30030 | 主题内容审查失败, 请查看 `erro` 了解详情
30040 | 内容含有太多争议, 正处于重新审查状态, 请查看 `erro` 了解详情
30050 | 内容被举报了, 请查看 `erro` 了解详情
30060 | 初始审查中

#### /new/post

预生成一个主题 ID 并获取该 ID.

##### METHOD: `GET`

##### URL: `/v1/new/post`

无参数。

> 注意: 该接口实际未向数据库或缓存中创建主题, 仅生成了一个未被使用的主题 ID, 该接口主要功能是防止重复提交主题.

##### REQUEST BODY: 无

##### DATA 数据结构

```json
int
```

仅返回主题 `ID`.

##### CODE 列表

错误码 | 含义
----- | ---- 
41010 | `id` 生成失败, 请查看 `erro` 了解详细日志

#### /post/id

向指定预生成的 ID 提交主题.

##### METHOD: `POST` 请求

##### URL: `/v1/post/10001`

参数含义如下:

参数名 | 含义 | 类型 | 缺省值
----- | ---- | ---- | ------
id | 预生成主题的 ID, 该 ID 必须通过 `/new/post` 接口获取 | int | 无, 不填返回 `404`

##### REQUEST BODY 数据结构

```json
  {
    "text": "这是一个主题内容，布拉布拉布拉，拉布拉布拉布拉"
  }
```

参数介绍：

参数名 | 含义 | 类型 | 缺省值 | 限制
----- | ---- | ---- | ------
text | 主题内容 | string | 无 | 不可为空, 最大长度为 **5000** 个字

##### DATA 数据结构

```json
int
```

仅返回主题 `ID`.

##### CODE 列表

错误码 | 含义
----- | ---- 
40001 | 找不到指定预生成的 ID, 请先通过 `/new/post` 接口获取预生成的 ID, 再提交主题
40010 | REQUEST BODY 数据解析失败, 请查看 `erro` 了解详细日志
40020 | 主题内容超过字数限制, 请将内容字数限制在 `5000` 字范围内
40030 | 播放数据库失败，请查看 `erro` 了解详细日志

> 提交成功后, 即开启一个随机匿名空间.

#### /space/token

进入一个随机匿名空间, 或通过指定的 `Token` 进入一个随机匿名空间.

##### METHOD: `GET`

##### URL: 

- `/v1/space`
- `/v1/space/fe1220b6-31bc-4008-b4a6-3d432281ff45`

参数含义如下:

参数名 | 含义 | 类型 | 缺省值
----- | ---- | ---- | ------
token | 可访问指定随机匿名空间的令牌, 可通过 `/space/token` 接口获取 | string(uuid) | 无, 可为空

> token 为空时, 访问随机匿名空间将成为一个随机事件, 其中有 30% 的几率成功, 70% 的几率失败, 失败将返回 `60020`.

##### DATA 数据结构:

```json
{
  "raSpace": {
      "id": 3,
      "subject": "请检查新主题中是否含有违反守约的内容，谢谢。",
      "post": {
          "id": 10002,
          "text": "vscode 升级后智能提示快多了，之前提示的还没手写的快，约等于没有，赞。",
          "status": 0,
          "remark": "",
          "createdAt": "2020-06-10 11:03:00"
      },
      "postId": 10002,
      "status": 0,
      "createdAt": "2020-06-10 11:03:00"
  },
  "raSpaceId": 3,
  "token": "6db70600-997d-4bc1-88f1-0357f114ed17",
  "status": 0,
  "remark": ""
}
```

`token` 为空时, 系统将为本次访问生成一个随机令牌 (uuid), 通过该令牌, 可访问指定的随机匿名空间.

令牌有效时长为 `3天`.

> `token` 的使用权仅有一次, 在调用 `/vote/token` 接口之后, 该 `token` 失效。

##### CODE 列表: 

错误码 | 含义
----- | ---- 
60000 | 当前没有开启的随机匿名空间
60010 | Token 错误或已失效 (已被使用)
60011 | 根据 Token 获取对应的 RASpace ID 时失败, 请查看 `erro` 了解详细日志
60020 | 欢迎下次再来
60030 | 查询数据失败, 请查看 `erro` 了解详细日志
60031 | 解析数据失败, 请查看 `erro` 了解详细日志
60032 | 在查询该空间审查的主题时失败, 请查看 `erro` 了解详细日志
60040 | 发生未知错误, 请查看 `erro` 了解详细日志

#### /vote/token

表决指定匿名空间的主题.

##### METHOD: `POST`

##### URL: `/v1/vote/6db70600-997d-4bc1-88f1-0357f114ed17`

参数含义如下:

参数名 | 含义 | 类型 | 缺省值
----- | ---- | ---- | ------
token | 可访问指定随机匿名空间的令牌, 可通过 `/space/token` 接口获取 | string(uuid) | 无, 不填空返回 `404`

##### REQUEST BODY 数据结构

```json
{
  "token": "48c49247-af74-43dd-920e-9a01aeabbc94",
  "status": 1,
  "remark": "支持作者"
}
```

参数介绍：

参数名 | 含义 | 类型 | 缺省值 | 限制
----- | ---- | ---- | ------ | ------
token | 表决者令牌, 与空间令牌 (`/space/token`) 不同 | string | 随机 uuid | 无
status | 表决状态, 1: 允许, 2: 不允许, 3: 有争议或弃票 | int | 无 | 不可为空, 且必须是 {1, 2, 3} 之一
remark | 表决理由 | string | 无 | 无

##### DATA 数据: 无

当表决数量达到最大表决数量时, 表决结束. 当表决结束后, 随机匿名空间立即关闭. 如果表决结果为 `StatusAbstain (3)` 时, 表示该主题存在许多争议, 将会立即重新开启一个随机匿名空间.

##### CODE 列表

错误码 | 含义
----- | ---- 
70001 | 没有 Token
70002 | Token 错误或已失效 (已被使用)
70003 | 解析数据失败, 请查看 `erro` 了解详细日志
70010 | 内部数据转换错误, 请查看 `erro` 了解详细日志
70011 | 指定 Token 的随机匿名空间已关闭
70012 | 解析 REQUEST BODY 错误, 请查看 `erro` 了解详细日志
70013 | `status` 值不在范围内, 请参考 `REQUEST BODY` 的参数介绍部分
70014 | 该表决者已表决, 不可重复表决
70015 | 查询数据库失败, 请查看 `erro` 了解详细日志
70016 | 缓存数据解析失败, 请查看 `erro` 了解详细日志
70017 | 表决数据插入失败, 请查看 `erro` 了解详细日志
70018 | 表决历史获取失败, 请查看 `erro` 了解详细日志
70020 | 主题状态更新失败, 请查看 `erro` 了解详细日志
70021 | 随机匿名空间数据更新失败, 请查看 `erro` 了解详细日志
70030 | 发生未知错误, 请查看 `erro` 了解详细日志

### 后续

待续